# 新系统开放设计方案 (Water-Mall 2.0)

## 1. 设计目标
- **高性能**: 支持高并发订单处理与实时派单。
- **高可用**: 采用云原生架构，支持弹性伸缩。
- **高安全**: 全链路数据加密，完善的权限控制 (RBAC)。
- **易扩展**: 模块化设计，支持多租户 SaaS 模式。

## 2. 技术选型 (已确认)

### 后端 (Backend)
- **语言**: TypeScript (Node.js)
- **框架**: **NestJS**
    - **架构风格**: **Modular Monolith (模块化单体)**。
    - **理由**: 鉴于目前仅5家商户且追求“轻量化”，微服务架构（Microservices）运维成本过高且不必要。NestJS 的 Module 机制完美支持模块隔离，未来业务量增长时可轻松拆分为微服务。

### 前端 (Frontend)
- **管理后台 (Admin & Merchant)**: 
    - **框架**: React 18 + **Ant Design Pro** (UmiJS)。
    - **理由**: 开箱即用的中后台解决方案，完美契合管理端需求。
- **小程序 (Mini-App)**:
    - **框架**: **Uni-app** (Vue 3 版本)。
    - **理由**: 一套代码编译发布至微信、抖音等多端，生态成熟。

### 数据库与中间件
- **数据库**: **PostgreSQL 15+** (推荐替换 MySQL)
    - **为什么比 MySQL 更好?**
        1.  **PostGIS 地理信息支持**: 水站配送的核心是**基于位置的调度** (LBS)。PostGIS 是世界上最强大的开源地理空间数据库引擎，能极其高效地处理 "查找附近的配送员"、"电子围栏判定" 等查询，远胜 MySQL。
        2.  **JSONB 支持**: 现有系统的商品规格 (SKU) 和复杂的营销配置 (Activity Config) 适合用 JSONB 存储，既保持 SQL 的强一致性，又拥有 NoSQL 的灵活性，减少大量连表查询。
        3.  **现代标准**: 对于 Node.js/NestJS 生态，PostgreSQL + Prisma/TypeORM 是目前的黄金组合。
- **ORM**: **Prisma** (推荐) 或 TypeORM。Prisma 对 TypeScript 类型支持极其完美，开发体验极佳。
- **缓存/队列**: Redis (用于缓存、Session、简单的任务队列)。

## 3. 核心架构设计

### 3.1 模块划分 (NestJS Modules)
采用单体仓库 (Monorepo) + 模块化设计：
1.  **Auth Module**: 统一认证 (JWT, Guard)。
2.  **Core Module**: 全局拦截器、过滤器、配置中心。
3.  **Product Module**: 商品、SKU、库存管理 (使用 JSONB 优化多规格存储)。
4.  **Order Module**: 订单状态机、支付回调。
5.  **Dispatch Module (基于 PostGIS)**: 
    - 存储配送员实时坐标 (Point)。
    - 计算配送距离与最优路径。
    - 简单的自动派单算法 (最近距离/负载均衡)。
6.  **Partner Module**: 分红与佣金计算。

### 3.2 派单系统改进
- **现状**: 简单的逻辑派单。
- **新方案**: 
    - 引入 **GeoHash** 存储用户和配送员位置。
    - 实时 WebSocket 推送订单给配送员。
    - 增加“抢单”模式和“兜底派单”模式。

### 3.3 数据安全
- 敏感数据 (手机号、密码) 包含加密存储。
- 所有 API 启用 HTTPS。
- 完善的 SQL 注入防护 (ORM 层处理)。
- 操作日志全记录。

## 4. 迁移策略
1.  **数据清洗**: 编写脚本将旧 `wyu_` 表数据迁移至新 Schema。
2.  **并行运行**: 新旧系统在不同域名并存，逐步切换流量。
3.  **兼容性**: 保持小程序 API 签名短期兼容，平滑升级 C 端。
