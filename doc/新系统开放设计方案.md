# 新系统开放设计方案 (Water-Mall 2.0)

## 1. 设计目标
- **高性能**: 支持高并发订单处理与实时派单。
- **高可用**: 采用云原生架构，支持弹性伸缩。
- **高安全**: 全链路数据加密，完善的权限控制 (RBAC)。
- **易扩展**: 模块化设计，支持多租户 SaaS 模式。

## 2. 技术选型 (已确认)

### 后端 (Backend)
- **语言**: TypeScript (Node.js)
- **框架**: **NestJS**
    - **架构风格**: **Modular Monolith (模块化单体)**。
    - **理由**: 鉴于目前仅5家商户且追求“轻量化”，微服务架构（Microservices）运维成本过高且不必要。NestJS 的 Module 机制完美支持模块隔离，未来业务量增长时可轻松拆分为微服务。

### 前端 (Frontend)
- **管理后台 (Admin & Merchant)**: 
    - **框架**: React 18 + **Ant Design Pro** (UmiJS)。
    - **理由**: 开箱即用的中后台解决方案，完美契合管理端需求。
- **小程序 (Mini-App)**:
    - **框架**: **Uni-app** (Vue 3 版本)。
    - **理由**: 一套代码编译发布至微信、抖音等多端，生态成熟。

### 数据库与中间件
- **数据库**: **PostgreSQL 15+** (推荐替换 MySQL)
    - **为什么比 MySQL 更好?**
        1.  **PostGIS 地理信息支持**: 水站配送的核心是**基于位置的调度** (LBS)。PostGIS 是世界上最强大的开源地理空间数据库引擎，能极其高效地处理 "查找附近的配送员"、"电子围栏判定" 等查询，远胜 MySQL。
        2.  **JSONB 支持**: 现有系统的商品规格 (SKU) 和复杂的营销配置 (Activity Config) 适合用 JSONB 存储，既保持 SQL 的强一致性，又拥有 NoSQL 的灵活性，减少大量连表查询。
        3.  **现代标准**: 对于 Node.js/NestJS 生态，PostgreSQL + Prisma/TypeORM 是目前的黄金组合。
- **ORM**: **Prisma** (推荐) 或 TypeORM。Prisma 对 TypeScript 类型支持极其完美，开发体验极佳。
- **缓存/队列**: Redis (用于缓存、Session、简单的任务队列)。

## 3. 核心架构设计

### 3.1 模块划分 (NestJS Modules)
采用单体仓库 (Monorepo) + 模块化设计：
1.  **Auth Module**: 统一认证 (JWT, Guard)。
2.  **Core Module**: 全局拦截器、过滤器、配置中心。
3.  **Product Module**: 商品、SKU、库存管理 (使用 JSONB 优化多规格存储)。
4.  **Order Module**: 订单状态机、支付回调。
5.  **Dispatch Module (基于 PostGIS)**: 
    - 存储配送员实时坐标 (Point)。
    - 计算配送距离与最优路径。
    - 简单的自动派单算法 (最近距离/负载均衡)。
6.  **Partner Module**: 分红与佣金计算。
7.  **Marketing Module (增强)**:
    - **优惠券**: 增加 `applicable_scope` 字段 (JSONB)，支持指定商品/分类使用，不再局限于全场通用。

### 3.2 多租户策略 (Multi-tenancy)
采用 **逻辑隔离 (Logical Isolation)** 模式：
- **数据层面**: 所有表均通过 `shop_id` 字段区分商户。PostgreSQL 的 Row-Level Security (RLS) 或 NestJS 的全局 Scope Guard 确保商户只能访问自己的数据。
- **管理层面**: 
    - **商户依旧拥有独立后台**: 每个商户登录后仅看到自己的数据Dashboard，操作体验与老系统一致。
    - **总后台**: 平台管理员可查看所有商户数据。
- **优势**: 维护成本最低（无需为每个商户建库），资源利用率最高，完全满足目前及未来扩容需求。

### 3.3 小程序发布策略 (Simplified)
**不使用微信开放平台 (Third-party Platform) 授权模式**，改为 **独立开发/上传模式**：
1.  **代码复用**: 使用 Uni-app 开发一套标准代码。
2.  **配置化**: 通过 `project.config.json` 或环境变量区分不同商户的 `appid` 和后端 API 地址。
3.  **发布流程**:
    - **方式一 (简单)**: 使用“微信开发者工具”导入项目，修改 `appid` 后分别上传审核。
    - **方式二 (自动化)**: 使用 `miniprogram-ci` 脚本，在本地或服务器批量上传代码到各个商户的小程序后台。
- **理由**: 规避了开发复杂的“第三方平台代开发”逻辑，仅需维护一套代码，通过不同配置发布，非常适合 5-10 个商户的规模。

## 4. 迁移策略
1.  **数据清洗**: 编写脚本将旧 `wyu_` 表数据迁移至新 Schema。
2.  **并行运行**: 新旧系统在不同域名并存，逐步切换流量。
3.  **兼容性**: 保持小程序 API 签名短期兼容，平滑升级 C 端。
