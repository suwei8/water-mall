# 新系统开放设计方案 (Water-Mall 2.0)

## 1. 设计目标
- **高性能**: 支持高并发订单处理与实时派单。
- **高可用**: 采用云原生架构，支持弹性伸缩。
- **高安全**: 全链路数据加密，完善的权限控制 (RBAC)。
- **易扩展**: 模块化设计，支持多租户 SaaS 模式。

## 2. 技术选型

### 后端 (Backend)
- **语言**: TypeScript (Node.js) 或 Go
- **框架**: **NestJS** (推荐，企业级结构，完美支持 TS) 或 Gin (Go)
- **API 规范**: RESTful API + GraphQL (可选，用于复杂查询)
- **微服务/模块化**: 采用 Monorepo 策略，按 `Platform` (总控), `Merchant` (商户), `Delivery` (配送), `Member` (C端) 划分模块。

### 前端 (Frontend)
- **管理后台 (Admin & Merchant)**: 
    - **框架**: React 18 + **Ant Design Pro** 或 Vue 3 + Element Plus。
    - **特性**: 纯前后端分离，单页应用 (SPA)。
- **小程序 (Mini-App)**:
    - **框架**: **Uni-app** (Vue语法，多端发布) 或 Taro (React语法)。
    - **目标**: 微信小程序为主，预留 H5/抖音小程序能力。

### 数据库与中间件
- **数据库**: MySQL 8.0 (业务数据) + Redis (缓存/Session/队列)。
- **消息队列**: RabbitMQ 或 Redis Stream (用于订单派发异步处理、削峰填谷)。
- **搜索**: Elasticsearch (可选，用于订单/会员的高级搜索)。

## 3. 核心架构设计

### 3.1 模块划分
1.  **Auth Service**: 统一认证中心 (JWT, OAuth2)。
2.  **User Service**: 会员、商户、管理员信息。
3.  **Product Service**: 商品、库存、价格策略。
4.  **Order Service**: 订单全生命周期、状态机 (StateMachine)。
5.  **Dispatch Service (核心)**: 
    - 智能派单算法 (基于距离/负载)。
    - 抢单池/派单队列。
6.  **Finance Service**: 支付、结算、分账、提现。

### 3.2 派单系统改进
- **现状**: 简单的逻辑派单。
- **新方案**: 
    - 引入 **GeoHash** 存储用户和配送员位置。
    - 实时 WebSocket 推送订单给配送员。
    - 增加“抢单”模式和“兜底派单”模式。

### 3.3 数据安全
- 敏感数据 (手机号、密码) 包含加密存储。
- 所有 API 启用 HTTPS。
- 完善的 SQL 注入防护 (ORM 层处理)。
- 操作日志全记录。

## 4. 迁移策略
1.  **数据清洗**: 编写脚本将旧 `wyu_` 表数据迁移至新 Schema。
2.  **并行运行**: 新旧系统在不同域名并存，逐步切换流量。
3.  **兼容性**: 保持小程序 API 签名短期兼容，平滑升级 C 端。
